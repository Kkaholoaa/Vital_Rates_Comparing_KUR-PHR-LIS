---
title: "VitalRates_stats"
author: "Caroline Rodriguez"
date: "11/11/2020"
output: html_document
---

#Libraries
```{r}
library(ggplot2)
library(dplyr)
library(plyr)
library(tidyr)
```

#Set up
```{r}
setwd("/Users/c-rod/Documents/R_data/VitalRates/")
#load in .rdata file
load(file = "/Users/c-rod/Documents/R_data/VitalRates/Patch_And_Colony_Data_20201103.rdata")
#View both tables saved in the .rdata
View(ColonyLevel)
View(PatchLevel)

```


#Subset by Site
Going to use ColonyLevel data to avoid all the fission/fusion confusion
```{r}
MAISIOK01 <- subset(ColonyLevel, Site=="MAI_SIO_K01")
View(MAISIOK01)

KUROCC010 <- subset(ColonyLevel, Site=="KUR_OCC_010")
View(KUROCC010)

PHROCC016 <- subset(ColonyLevel, Site=="PHR_OCC_016")
View(PHROCC016)

```


#Plot by Colony Level (growth, shrink, mort, recruit)
```{r}
#change this basepath to your working directory on your computer
basepath="/Users/c-rod/Documents/R_data/VitalRates/"

#the shape palette is messed up because it can deal w/ a max of 6 discrete values and we have 53 b/c all the fissiongrowthfusion, growthfissionfission, etc. Instead used the TransitionTypeSimple (growth,shrink,mort, recr)
T0T1 = ggplot(data = MAISIOK01, aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple)) + 
  geom_point() + geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ #log transform x axis
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_grid(c("Genus_Code","Site"))+theme_bw()+ #facet_grid separates by Genus Code (makes 3 verticle plots) and Site (makes horizontal plots)
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1
scale=3
#save the plot
ggsave(filename = paste0(basepath,"Figures/TransitionTypeT0T1ByGenus_MAIK01.png"),
       plot=T0T1,width=6*scale,height=scale*3)

#same plot as above but adds lines
T0T1_lin = ggplot(data = MAISIOK01, aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple,group=ColonyID)) + 
  geom_point() + 
  geom_line(alpha=.15,color="black")+ #adds line connecting some patches
  geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ 
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_grid(c("Genus_Code","Site"),scales="free")+theme_bw()+
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1_lin

#################################
#Kure
T0T1K = ggplot(data = KUROCC010, aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple)) + 
  geom_point() + geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ #log transform x axis
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_grid(c("Genus_Code","Site"))+theme_bw()+ #facet_grid separates by Genus Code (makes 3 verticle plots) and Site (makes horizontal plots)
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1K
#ggsave(filename = paste0(basepath,"Figures/TransitionTypeT0T1ByGenus_KUR.png"),plot=T0T1K,width=6*scale,height=scale*3)

#################################
#PHR
T0T1P = ggplot(data = PHROCC016, aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple)) + 
  geom_point() + geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ #log transform x axis
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_grid(c("Genus_Code","Site"))+theme_bw()+ #facet_grid separates by Genus Code (makes 3 verticle plots) and Site (makes horizontal plots)
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1P
#ggsave(filename = paste0(basepath,"Figures/TransitionTypeT0T1ByGenus_PHR.png"),plot=T0T1P,width=6*scale,height=scale*3)

```

#Plot by Colony Level (growth, shrink, mort, recruit) and Transition
```{r}
#MAISIOK01
#By adding in interval in the facet_wrap, makes a plot for each time interval
#only included Montipora and Porites
T0T1y = ggplot(subset(MAISIOK01, Genus_Code%in%c("MOSP","POSP")), aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple)) + 
  geom_point(size=4) + geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ #log transform x axis
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_wrap(c("Spec_Code","Site","Interval"),scales="free")+ 
  theme(axis.text = element_text(size = 20))+ theme(axis.title = element_text(size = 20))+ theme(legend.text = element_text(size = 20))+ theme(legend.title = element_text(size = 26))+
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1y
ggsave(filename = paste0(basepath,"Figures/TransitionTypeT0T1ByGenus_ByYear_MAI2.png"),plot=T0T1y,width=8*scale,height=scale*5)

############################
#KUR
T0T1y_KUR = ggplot(data = KUROCC010, aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple)) + 
  geom_point() + geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ #log transform x axis
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_wrap(c("Spec_Code","Site","Interval"),scales="free")+
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1y_KUR
ggsave(filename = paste0(basepath,"Figures/TransitionTypeT0T1ByGenus_ByYear_KUR.png"),plot=T0T1y_KUR,width=8*scale,height=scale*5)

############################
#PHR
T0T1y_PHR = ggplot(data = PHROCC016, aes(x=StartingSize, y=EndingSize,color=TransitionTypeSimple,shape=TransitionTypeSimple)) + 
  geom_point() + geom_abline(slope = 1)+
  scale_x_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+ #log transform x axis
  scale_y_sqrt(breaks=c(10,50,100,250,500,1000,2000),limits=c(0,400))+
  scale_shape_manual(values=0:4)+
  facet_wrap(c("Spec_Code","Site","Interval"),scales="free")+
  xlab("Colony Size at Time T (cm^2)") + ylab("Colony Size at Time T+1 (cm^2)")
T0T1y_PHR
ggsave(filename = paste0(basepath,"Figures/TransitionTypeT0T1ByGenus_ByYear_PHR.png"),plot=T0T1y_PHR,width=8*scale,height=scale*5)

```



#Counting
```{r}
#Count the total number of transitions in the ENTIRE dataset that fit into the POCS, POSP, or MOSP genus category
total_POCS <- sum(with(ColonyLevel, Genus_Code=="POCS"))
total_POCS #331
total_MOSP <- sum(with(ColonyLevel, Genus_Code=="MOSP"))
total_MOSP #341
total_POSP <- sum(with(ColonyLevel, Genus_Code=="POSP"))
total_POSP #2014

#to count the # of each genus in the first year at the Maui site
POCS_MAI_2014 <- sum(with(MAISIOK01, Genus_Code=="POCS" & StartingYear==2014))
POCS_MAI_2014 #4 in 2014
POCS_MAI_2015 <- sum(with(MAISIOK01, Genus_Code=="POCS" & StartingYear==2015))
POCS_MAI_2015 #3 in 2014
MOSP_MAI14 <- sum(with(MAISIOK01, Genus_Code=="MOSP" & StartingYear==2014))
MOSP_MAI14 #88 in 2014
POSP_MAI14 <- sum(with(MAISIOK01, Genus_Code=="POSP" & StartingYear==2014))
POSP_MAI14 #107 in 2014


 
MOSP <- sum(with(MAISIOK01, Genus_Code=="MOSP"))
MOSP #214
POCS <- sum(with(MAISIOK01, Genus_Code=="POCS"))
POCS #10
POSP <- sum(with(MAISIOK01, Genus_Code=="POSP"))
POSP #288

table(MAI_SIO_K01$Genus_Code,useNA="always")
#MOSP 497, POCS 14, POSP 605

table(MAI_SIO_K01$TransitionTypeSimple,useNA="always")





#Count the number of mortality events in each transition
MAImort_1415 <- sum(with(MAISIOK01, TransitionTypeSimple=="MORT" & EndingYear==2015))
MAImort_1415 #26
MAImort_1516 <- sum(with(MAISIOK01, TransitionTypeSimple=="MORT" & EndingYear==2016))
MAImort_1516 #27
MAImort_1618 <- sum(with(MAISIOK01, TransitionTypeSimple=="MORT" & EndingYear==2018))
MAImort_1618 #36
#recruitment events
MAIrecr_1415 <- sum(with(MAISIOK01, TransitionTypeSimple=="RECR" & EndingYear==2015))
MAIrecr_1415 #8
MAIrecr_1516 <- sum(with(MAISIOK01, TransitionTypeSimple=="RECR" & EndingYear==2016))
MAIrecr_1516 #2
MAIrecr_1618 <- sum(with(MAISIOK01, TransitionTypeSimple=="RECR" & EndingYear==2018))
MAIrecr_1618 #34
#growth events
MAIgro_1415 <- sum(with(MAISIOK01, TransitionTypeSimple=="RECR" & EndingYear==2015))
MAIgro_1415 #8
MAIgro_1516 <- sum(with(MAISIOK01, TransitionTypeSimple=="RECR" & EndingYear==2016))
MAIgro_1516 #2
MAIshrin_1618 <- sum(with(MAISIOK01, TransitionTypeSimple=="RECR" & EndingYear==2018))
MAIshrin_1618 #34


```

#ignore this
```{r}
####Playing around with raw data files to count # of colonies in each genus in each year. Above ^^ is transitions
library(stringr)
MAI_SIO_K01_1 = read.csv("2014_MAI_SIO_k01_09022020.csv")
#View(MAI_SIO_K01_1)
MAI_SIO_K01_2 =read.csv("201507_201606_2018_MAI_SIO_K01_09022020.csv")
#View(MAI_SIO_K01_1)
names(MAI_SIO_K01_2)[names(MAI_SIO_K01_2) == "FID"] <- "OBJECTID"
setdiff(names(MAI_SIO_K01_1),names(MAI_SIO_K01_2)) 
MAI_SIO_K01_1$Id <- NULL
MAI_SIO_K01_1$Shape_Length <- NULL
MAI_SIO_K01_2$Shape_Leng <- NULL
MAI_SIO_K01=rbind(MAI_SIO_K01_1,MAI_SIO_K01_2)

GenusCodeLUnames=c("PMEA","PGRA","POSP","PLUT", "PLIC","MFLA","MPAT", "MOSP","POCS","POSP","PLOB","MCAP")
GenusCodeLU=c("POCS","POCS","POSP","POSP","POSP", "MOSP","MOSP", "MOSP","POCS","POSP","POSP","MOSP")
names(GenusCodeLU)=GenusCodeLUnames
MAI_SIO_K01$Spec_Code=str_trim(MAI_SIO_K01$Spec_Code)
drop_SpBlank=which(MAI_SIO_K01$Spec_Code=="")
if(length(drop_SpBlank)>0){MAI_SIO_K01=MAI_SIO_K01[-drop_SpBlank,]}
MAI_SIO_K01$Genus_Code=GenusCodeLU[MAI_SIO_K01$Spec_Code]
#table shows total # of colonies from each genus 
table(MAI_SIO_K01$Genus_Code,useNA="always")
#MOSP=497, POCS=14, POSP=606

#break this into each year
POCS_MAI_2014o <- sum(with(MAI_SIO_K01, Genus_Code=="POCS"& Date=='07/21/2014'))
POCS_MAI_2014o #5 POCS colonies
MOSP_MAI_2014o <- sum(with(MAI_SIO_K01, Genus_Code=="MOSP" & Date=='07/21/2014'))
MOSP_MAI_2014o #189 MOSP colonies
POSP_MAI_2014o <- sum(with(MAI_SIO_K01, Genus_Code=="POSP" & Date=='07/21/2014'))
POSP_MAI_2014o #162 POSP colonies
POCS_MAI_2015o <- sum(with(MAI_SIO_K01, Genus_Code=="POCS"& Date=='07/10/2015'))
POCS_MAI_2015o #4 POCS colonies  2in015


PHR = read.csv("PHR_OCC_016_100920.csv")
GenusCodeLUnames=c("PMEA","PGRA","POSP","PLUT", "PLIC","MFLA","MPAT", "MOSP","POCS","POSP","PLOB","MCAP")
GenusCodeLU=c("POCS","POCS","POSP","POSP","POSP", "MOSP","MOSP", "MOSP","POCS","POSP","POSP","MOSP")
names(GenusCodeLU)=GenusCodeLUnames
PHR$Spec_Code=str_trim(PHR$Spec_Code)
drop_SpBlank=which(PHR$Spec_Code=="")
if(length(drop_SpBlank)>0){PHR=PHR[-drop_SpBlank,]}
PHR$Genus_Code=GenusCodeLU[PHR$Spec_Code]
#table shows total # of colonies from each genus 
table(PHR$Genus_Code,useNA="always")
#216 POSP colonies
```

#ANCOVA 
We will run an ANCOVA because there are 2 independent/predictor variables: 1 categorial (species) and 1 continuous variable (????). <<<What variable is this?
Assumptions: equal variance, the data are normal, the residuals are normal, independence of covariate and treatment effect
```{r}
#Compare growth rates between two species

#first plot the growth rates for the two species (growth/shrink only, no recruitment or mortality)
growthshrink <- subset(ColonyLevel, TransitionTypeSimple == "GROWTH" & TransitionTypeSimple == "SHRINK")
#View(growthshrink)
#^^^this is not working correctly. Google how to subset two things at once

#test for equal variance
leveneTest(MAISIOK01$TransitionRate_L, MAISIOK01$)
#this may not run. Need to install one of these packages (google to figure out which one: ggpubr,sjstats,car,multcomp)

```





