---
title: "analysis"
author: "Devynn M Wulstein"
date: "3/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = FALSE)
```

```{r}
## Loading libraries
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
```


```{r}
# Loading dataframe(s)
AllDataFrame <- load("data/Patch_And_Colony_Data_20201103.rdata")
```

```{r}
# Defining site IDs, genera names, and transition intervals (years) as lists
SiteNames <- as.character(unique(ColonyLevel$Site))
GeneraNames <- as.character(unique(ColonyLevel$Genus_Code))
IntervalYears <- unique(ColonyLevel$Interval_Years)

# Ensuring that the log size values are numbers (I think they are numeric, but maybe not!)
# And that the -Infs are NAs instead
ColonyLevel$ln_ES <- as.numeric(ColonyLevel$ln_ES)
ColonyLevel$ln_SS[ColonyLevel$ln_ES == -Inf] <-NA

ColonyLevel$ln_SS <- as.numeric(ColonyLevel$ln_SS)
ColonyLevel$ln_SS[ColonyLevel$ln_SS == -Inf] <-NA

ColonyLevel <- cbind(ColonyLevel, data.frame(Survival = 1 - ColonyLevel$Mortality))
```

The aim of this analysis is to calculate the kernel fits (growth, survival, & reproduction) for each combination of genera-site-year and then each separately. 

Full models:
(1) Each Genera for all sites & interval years
(2) Each Site for all genera & interval years
(3) Each Interval Year for all sites & genera

Individual models: (the more realistic models that we are more interested in)
(1) Each Genera by interval year, sites are not separated
(2) Each Genera by site, interval years are not separated
(3) Each genera by site and interval year (we will have parameter values that equal site * interval years * genera)
```{r}
################################################################################
##### Survival dataset #########################################################
## Had issues with the glm because of the data #################################
# This only counts the surv/mortality that happen not the instances 
# where it had happened before and the colony didn't come back
################################################################################

surv_dat <- data.frame()
for (i in 1:nrow(ColonyLevel)){
  if(ColonyLevel$Survival[i] == 0){
    surv_dat <- rbind(surv_dat, data.frame(ColonyID = ColonyLevel$ColonyID[i], 
                                size = ColonyLevel$ln_SS[i-1], survival = 0, 
                                Genus_Code = ColonyLevel$Genus_Code[i],
                                Interval_Years = ColonyLevel$Interval_Years[i],
                                Site = ColonyLevel$Site[i])) 
  }
  else{
    surv_dat <- rbind(surv_dat, data.frame(ColonyID = ColonyLevel$ColonyID[i], 
                                size = ColonyLevel$ln_SS[i], survival = 1, 
                                Genus_Code = ColonyLevel$Genus_Code[i],
                                Interval_Years = ColonyLevel$Interval_Years[i],
                                Site = ColonyLevel$Site[i]))}
}

# modS <- glm(survival ~ size, family = "binomial" , data = surv_dat)
# plot(jitter(survival, 0.1) ~ size, store_dat)
# ss <- seq(-3, 9, 0.1)
# lines(ss, predict(modS, list(size = ss), type="response"), pch=8)
```

```{r FULLmodGROWTH, eval = TRUE}
################################################################################
################### Model with no separation of terms ##########################
################################################################################
Growth <- subset(ColonyLevel, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")

#Growth Model
mod <- lm(ln_ES ~ ln_SS, data = Growth)
SlpVar <- (summary(mod)$sigma)**2
aicVal <- AIC(mod)

# saving model coefficients and notes into dataframe with corresponding uniqueID
GrowthDataFrame <- data.frame(Model_IDs ="All_Genera_n_Sites_n_Years", 
                              g.int = coef(mod)[1], 
                              g.slp = coef(mod)[2], g.var = SlpVar, 
                              AIC = aicVal, growth_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(Growth$ln_SS)))

#Survival Model
modS <- glm(survival ~ size, family = "binomial" , data = surv_dat)
aicValS <- AIC(modS)


# saving model coefficients and notes into dataframe with corresponding uniqueID
SurvivalDataFrame <- data.frame(Model_IDs = "All_Genera_n_Sites_n_Years", 
                                s.int = coef(modS)[1], s.slp = coef(modS)[2], 
                                AIC = aicValS, survival_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(surv_dat$size)))

```



```{r}
################################################################################
################### Models Separated by Major Groupings ########################
################# (1) Genera, (2) Site, and (3) Interval Year ##################
################################################################################

################################################################################
###### 1. Genera models ########################################################
################################################################################
  
# initializing the data runs for the growth analysis
# define the parms for model loop
Focus <- GeneraNames 
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Genus_Code
Spec_selection_S <- surv_dat$Genus_Code
minTrans <- 4 # minimum number of transitions

growth <- matrix(0, nrow = 2, ncol = LoopLength)
Var <- Var_S <- c()
aic <- aic_S <- c()
survival <- growth

note <- Snote <- c()
for (i in 1:LoopLength){
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset1_S <- subset(surv_dat, Spec_selection_S == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS
  ln_ES <- subset2$ln_ES
  
  # Saving growth model
  if (length(ln_SS) >= minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    note[i] <- sprintf("Num of transitions = %s", 
                    length(ln_SS))
    
    growth[,i] <- coef(mod)
    Var[i] <- (summary(mod)$sigma)**2
    aic[i] <- AIC(mod)
    }
  
  if (length(ln_SS) < minTrans){
    #setting values to NaNs
    note[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(ln_SS))
    growth[,i] <- NaN
    Var[i] <- NA
    aic[i] <- NA
    }
  
  # Row binding the model results into the growth model dataframe
  
  df <- data.frame(Model_IDs = sprintf("%s_All_Sites_n_Years",Focus[i]), 
                 g.int = growth[1,i], g.slp = growth[2,i], g.var = Var[i], 
                 AIC = aic[i], growth_notes = note[i])
  
  GrowthDataFrame <- rbind(GrowthDataFrame,df)
  
  # Saving survival model
  
  if (length(subset1_S$size) >= minTrans){
    modS <- glm(survival ~ size, family = "binomial" , data = subset1_S)
    Snote[i] <- sprintf("Num of transitions = %s", 
                    length(subset1_S$size))
    
    survival[,i] <- coef(modS)
    Var_S[i] <- (summary(modS)$sigma)**2
    aic_S[i] <- AIC(modS)
    }
  
  if (length(subset1_S$size) < minTrans){
    #setting values to NaNs
    Snote[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(subset1_S$size))
    survival[,i] <- NaN
    Var_S[i] <- NA
    aic_S[i] <- NA
    }
  

 # Row binding the model results into the growth model dataframe
  
  dfS <- data.frame(Model_IDs = sprintf("%s_All_Sites_n_Years",Focus[i]), 
                                s.int = survival[1,i], s.slp = survival[2,i], 
                                AIC = aic_S, survival_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(ColonyLevel$ln_SS)))
  
   SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
  }

```

```{r}
################################################################################
###### 2. Site models ##########################################################
################################################################################

# initializing the data runs for the growth analysis
# define the parms for model loop
Focus <- SiteNames 
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Site
Spec_selection_S <- surv_dat$Site
minTrans <- 4 # minimum number of transitions

growth <- matrix(0, nrow = 2, ncol = LoopLength)
survival <- growth
Var <- Var_S <- c()
aic <- aic_S <- c()
note <- Snote <- c()

for (i in 1:LoopLength){
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset1_S <- subset(surv_dat, Spec_selection_S == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS
  ln_ES <- subset2$ln_ES
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    note[i] <- sprintf("Num of transitions = %s", length(ln_SS))
    
    growth[,i] <- coef(mod)
    Var[i] <- (summary(mod)$sigma)**2
    aic[i] <- AIC(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    note[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(ln_SS))
    growth[,i] <- NaN
    Var[i] <- NA
    aic[i] <- NA}

  # saving the growth model
  df <- data.frame(Model_IDs = sprintf("%s_All_Genera_n_Years",Focus[i]), 
                 g.int = growth[1,i], g.slp = growth[2,i], 
                 g.var = Var[i], AIC = aic[i], growth_notes = note[i])
  
  GrowthDataFrame <- rbind(GrowthDataFrame,df)
  
  # Survival model 
  if (length(subset1_S$size) >= minTrans){
    modS <- glm(survival ~ size, family = "binomial" , data = subset1_S)
    Snote[i] <- sprintf("Num of transitions = %s", 
                    length(subset1_S$size))
    
    survival[,i] <- coef(modS)
    Var_S[i] <- (summary(modS)$sigma)**2
    aic_S[i] <- AIC(modS)
    }
  
  if (length(subset1_S$size) < minTrans){
    #setting values to NaNs
    Snote[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(subset1_S$size))
    survival[,i] <- NaN
    Var_S[i] <- NA
    aic_S[i] <- NA
    }
  

 # Row binding the model results into the growth model dataframe
  
  dfS <- data.frame(Model_IDs = sprintf("%s_All_Genera_n_Years",Focus[i]), 
                                s.int = survival[1,i], s.slp = survival[2,i], 
                                AIC = aic_S, survival_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(ColonyLevel$ln_SS)))
  
   SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
  }

```

```{r}
################################################################################
###### 3. Interval Year models #################################################
################################################################################

# initializing the data runs for the growth analysis
# define the parms for model loop
Focus <- IntervalYears 
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Interval_Years
Spec_selection_S <- surv_dat$Interval_Years
minTrans <- 4 # minimum number of colonies

growth <- matrix(0, nrow = 2, ncol = LoopLength)
survival <- growth
Var <- Var_S <- c()
aic <- aic_S <- c()
note <- Snote <- c()


for (i in 1:LoopLength){
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset1_S <- subset(surv_dat, Spec_selection_S == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS
  ln_ES <- subset2$ln_ES
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    note[i] <- sprintf("Num of transitions = %s", length(ln_SS))
    
    growth[,i] <- coef(mod)
    Var[i] <- (summary(mod)$sigma)**2
    aic[i] <- AIC(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    note[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(ln_SS))
    growth[,i] <- NaN
    Var[i] <- NA
    aic[i] <- NA}
  
  df <- data.frame(Model_IDs = sprintf("%s_All_Genera_n_Sites",Focus[i]), 
                 g.int = growth[1,i], g.slp = growth[2,i], 
                 g.var = Var[i], AIC = aic[i], growth_notes = note[i])
  
  GrowthDataFrame <- rbind(GrowthDataFrame,df)
  
   # Survival model 
  if (length(subset1_S$size) >= minTrans){
    modS <- glm(survival ~ size, family = "binomial" , data = subset1_S)
    Snote[i] <- sprintf("Num of transitions = %s", 
                    length(subset1_S$size))
    
    survival[,i] <- coef(modS)
    Var_S[i] <- (summary(modS)$sigma)**2
    aic_S[i] <- AIC(modS)
    }
  
  if (length(subset1_S$size) < minTrans){
    #setting values to NaNs
    Snote[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(subset1_S$size))
    survival[,i] <- NaN
    Var_S[i] <- NA
    aic_S[i] <- NA
    }
  

  # Row binding the model results into the growth model dataframe
  
  dfS <- data.frame(Model_IDs = sprintf("%s_All_Genera_n_Sites",Focus[i]), 
                                s.int = survival[1,i], s.slp = survival[2,i], 
                                AIC = aic_S, survival_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(ColonyLevel$ln_SS)))
  
   SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
  
  }

```

```{r}
################################################################################
###### 4. Genera + Site for all Interval Years models ##########################
################################################################################

# define the parms for model loop
# Now with a second "Focus"

Focus <- GeneraNames
subFocus <- SiteNames
LoopLength <- length(Focus)
LoopLengthSF <-  length(subFocus)
Spec_selection <- Genus_Code
Spec_selectionSF <- Site

# setting minimum number of colonies
minTrans <- 4 

for (i in 1:LoopLength){
  
  # redefine the matrix for each Focus step
  growth <- matrix(0, nrow = 2, ncol = LoopLengthSF)
  survival <- growth
  note <- Var <- aic <- c()
  Snote <- Var_S <- aic_S <- c()
  
  # subset ColonyLevel to specify first focus
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset1_S <- subset(surv_dat, Spec_selection == Focus[i])

  for (v in 1:LoopLengthSF){
    # subsetting for growth & shrinkage
    subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
    
    # subsetting growth & shrinkage for second focus
    subset3 <- subset(subset2, Spec_selectionSF == subFocus[v])
    subset2_S <- subset(subset1_S, Spec_selectionSF == subFocus[v])
    
    ln_SS <- subset3$ln_SS
    ln_ES <- subset3$ln_ES
    
    if (length(ln_SS) > minTrans){
      mod <- lm(ln_ES ~ ln_SS)
      note[v] <- sprintf("Num of transitions = %s", length(ln_SS))
      growth[,v] <- coef(mod)
      Var[v] <- (summary(mod)$sigma)**2
      aic[v] <- AIC(mod)}
    
    if (length(ln_SS) <= minTrans){
      #setting values to NaNs
      note[v] <- sprintf("Not enough data. Num transitions = %s", 
                      length(ln_SS))
      growth[,v] <- NaN
      Var[v] <- NA
      aic[v] <- NA}
    
  df <- data.frame(Model_IDs = sprintf("%s_%s_All_Years",Focus[i], subFocus[v]), 
                 g.int = growth[1,v], g.slp = growth[2,v], 
                 g.var = Var[v], AIC = aic[v], growth_notes = note[v])
  
  GrowthDataFrame <- rbind(GrowthDataFrame,df)
  
  # Survival model 
  if (length(subset2_S$size) >= minTrans){
    modS <- glm(survival ~ size, family = "binomial" , data = subset2_S)
    Snote[v] <- sprintf("Num of transitions = %s", 
                    length(subset2_S$size))
    
    survival[,v] <- coef(modS)
    Var_S[v] <- (summary(modS)$sigma)**2
    aic_S[v] <- AIC(modS)
    }
  
  if (length(subset2_S$size) < minTrans){
    #setting values to NaNs
    Snote[v] <- sprintf("Not enough data. Num transitions = %s", 
                    length(subset2_S$size))
    survival[,v] <- NaN
    Var_S[v] <- NA
    aic_S[v] <- NA
    }
  

  # Row binding the model results into the growth model dataframe
  
  dfS <- data.frame(Model_IDs = sprintf("%s_All_Years",Focus[v]), 
                                s.int = survival[1,v], s.slp = survival[2,v], 
                                AIC = aic_S, survival_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(ColonyLevel$ln_SS)))
  
   SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
   
  }
}
```

```{r}
################################################################################
###### 5. Genera + Interval Years for all Site models ##########################
################################################################################

# define the parms for model loop
# Now with a second "Focus"

Focus <- GeneraNames
subFocus <- IntervalYears
LoopLength <- length(Focus)
LoopLengthSF <-  length(subFocus)
Spec_selection <- Genus_Code
Spec_selectionSF <- Interval_Years

# setting minimum number of transitions
minTrans <- 4 

for (i in 1:LoopLength){
  
  # redefine the matrix for each Focus step
  growth <- matrix(0, nrow = 2, ncol = LoopLengthSF)
  survival <- growth
  note <- Var <- aic <- c()
  Snote <- Var_S <- aic_S <- c()
  
  # subset data frames to specify first focus
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset1_S <- subset(surv_dat, Spec_selection == Focus[i])

  for (v in 1:LoopLengthSF){
    
    # subsetting for growth & shrinkage
    subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
    
    # subsetting growth & shrinkage for second focus
    subset3 <- subset(subset2, Spec_selectionSF == subFocus[v])
    subset2_S <- subset(subset1_S, Spec_selectionSF == subFocus[v])
    
    ln_SS <- subset3$ln_SS
    ln_ES <- subset3$ln_ES

    if (length(ln_SS) > minTrans){
      mod <- lm(ln_ES ~ ln_SS)
      note[v] <- sprintf("Num of transitions = %s", length(ln_SS))
      growth[,v] <- coef(mod)
      Var[v] <- (summary(mod)$sigma)**2
      aic[v] <- AIC(mod)}
    
    if (length(ln_SS) <= minTrans){
      #setting values to NaNs
      note[v] <- sprintf("Not enough data. Num transitions = %s", 
                      length(ln_SS))
      growth[,v] <- NaN
      Var[v] <- NA
      aic[v] <- NA}
    
    df <- data.frame(Model_IDs = sprintf("%s_%s_All_Sites",Focus[i], subFocus[v]), 
               g.int = growth[1,v], g.slp = growth[2,v], 
               g.var = Var[v], AIC = aic[v], growth_notes = note[v])
  
    GrowthDataFrame <- rbind(GrowthDataFrame,df)
  
    # Survival model 
    if (length(subset2_S$size) >= minTrans){
      modS <- glm(survival ~ size, family = "binomial" , data = subset2_S)
      Snote[v] <- sprintf("Num of transitions = %s", 
                      length(subset2_S$size))
      
      survival[,v] <- coef(modS)
      Var_S[v] <- (summary(modS)$sigma)**2
      aic_S[v] <- AIC(modS)
      }
    
    if (length(subset2_S$size) < minTrans){
      #setting values to NaNs
      Snote[v] <- sprintf("Not enough data. Num transitions = %s", 
                      length(subset2_S$size))
      survival[,v] <- NaN
      Var_S[v] <- NA
      aic_S[v] <- NA
      }
    
  
    # Row binding the model results into the growth model dataframe
    
    dfS <- data.frame(Model_IDs = sprintf("%s_All_Sites",Focus[v]), 
                                  s.int = survival[1,v], s.slp = survival[2,v], 
                                  AIC = aic_S, survival_notes = 
                                  sprintf("Num of transitions used equals %s", 
                                          length(subset2_S)))
    
     SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
  }

}
```

```{r}
################################################################################
###### 6. Site + Interval Years for all Genera models ##########################
################################################################################

# define the parms for model loop
# Now with a second "Focus"

Focus <-SiteNames
subFocus <- IntervalYears
LoopLength <- length(Focus)
LoopLengthSF <-  length(subFocus)
Spec_selection <- Site
Spec_selectionSF <- Interval_Years

# setting minimum number of transitions
minTrans <- 4 

for (i in 1:LoopLength){
  
  # redefine the matrix for each Focus step
  growth <- matrix(0, nrow = 2, ncol = LoopLengthSF)
  survival <- growth
  note <- Var <- aic <- c()
  Snote <- Var_S <- aic_S <- c()
  
  # subset ColonyLevel to specify first focus
  subset1 <- subset(ColonyLevel, Site == Focus[i])
  subset1 <- subset(surv_dat, Site == Focus[i])

  for (v in 1:LoopLengthSF){
    
    # subsetting for growth & shrinkage
    subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
    
    # subsetting for Interval_Years
    subset3 <- subset(subset2, Interval_Years == subFocus[v])
    subset2_S <- subset(subset1_S, Interval_Years == subFocus[v])
    
    ln_SS <- subset3$ln_SS
    ln_ES <- subset3$ln_ES
    
    if (length(ln_SS) > minTrans){
      mod <- lm(ln_ES ~ ln_SS)
      note[v] <- sprintf("Num of transitions = %s", length(ln_SS))
      growth[,v] <- coef(mod)
      Var[v] <- (summary(mod)$sigma)**2
      aic[v] <- AIC(mod)}
    
    if (length(ln_SS) <= minTrans){
      #setting values to NaNs
      note[v] <- sprintf("Not enough data. Num transitions = %s", 
                      length(ln_SS))
      growth[,v] <- NaN
      Var[v] <- NA
      aic[v] <- NA}
    
    # saving growth model 
    
    df <- data.frame(Model_IDs = sprintf("%s_%s_All_Genera",Focus[i], subFocus[v]), 
             g.int = growth[1,v], g.slp = growth[2,v], 
             g.var = Var[v], AIC = aic[v], growth_notes = note[v])
  
    GrowthDataFrame <- rbind(GrowthDataFrame,df)
    
    # Survival model 
    if (length(subset2_S$size) >= minTrans){
      modS <- glm(survival ~ size, family = "binomial" , data = subset2_S)
      Snote[v] <- sprintf("Num of transitions = %s", 
                      length(subset2_S$size))
      
      survival[,v] <- coef(modS)
      Var_S[v] <- (summary(modS)$sigma)**2
      aic_S[v] <- AIC(modS)
      }
    
    if (length(subset2_S$size) < minTrans){
      #setting values to NaNs
      Snote[v] <- sprintf("Not enough data. Num transitions = %s", 
                      length(subset2_S$size))
      survival[,v] <- NaN
      Var_S[v] <- NA
      aic_S[v] <- NA
      }
    
  
    # Row binding the model results into the survival model dataframe
    
    dfS <- data.frame(Model_IDs = sprintf("%s_All_Genera",Focus[v]), 
                                  s.int = survival[1,v], s.slp = survival[2,v], 
                                  AIC = aic_S, survival_notes = 
                                  sprintf("Num of transitions used equals %s", 
                                          length(subset2_S)))
    
    SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
     
  
  }

}

```

```{r}
################################################################################
###### 7. Genera + Site + Interval Years  models ###############################
################################################################################
# define the parms for model loop
# Now with a second "Focus"

Focus <- GeneraNames
subFocus <- SiteNames
subFocus2 <- IntervalYears
LoopLength <- length(Focus)
LoopLengthSF <-  length(subFocus)
LoopLengthSF2 <-  length(subFocus2)
# Spec_selection <- Genus_Code
# Spec_selectionSF <- Site
# Spec_selectionSF2 <- Interval_Years

minTrans <- 4 

for (i in 1:LoopLength){
  
  # subset Genus_Code for specific genera
  subset1 <- subset(ColonyLevel, Genus_Code == Focus[i])
  subset1_S <- subset(surv_dat, Genus_Code == Focus[i])

  for (v in 1:LoopLengthSF){
    
    # redefine the matrix for each Focus step
    growth <- matrix(0, nrow = 2, ncol = LoopLengthSF2)
    survival <- growth
    note <- Var <- aic <- c()
    Snote <- aic_S <- c()
    
    # subsetting for growth & shrinkage
    subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
    
    # subsetting growth & shrinkage for specific Site
    subset3 <- subset(subset2, Site == subFocus[v])
    
    #subsetting genera specific into Site specific
    subset2_S <- subset(subset1_S, Site == subFocus[v])
    
    for (y in 1:LoopLengthSF2){
      
      #subsetting genera specific & Site specific into interval year specific
      subset4 <- subset(subset3, Interval_Years == subFocus2[y])
      subset3_S <- subset(subset2_S, Interval_Years == subFocus2[y])
      
      ln_SS <- subset4$ln_SS
      ln_ES <- subset4$ln_ES
      
      if (length(ln_SS) > minTrans){
        mod <- lm(ln_ES ~ ln_SS)
        note[y] <- sprintf("Num of transitions = %s", length(ln_SS))
        growth[,y] <- coef(mod)
        Var[y] <- (summary(mod)$sigma)**2
        aic[y] <- AIC(mod)}
      
      if (length(ln_SS) <= minTrans){
        #setting values to NaNs
        note[y] <- sprintf("Not enough data. Num transitions = %s", 
                        length(ln_SS))
        growth[,y] <- NaN
        Var[y] <- NA
        aic[y] <- NA}
      
      df <- data.frame(Model_IDs = sprintf("%s_%s_%s",Focus[i], 
                                           subFocus[v], subFocus2[y]), 
                 g.int = growth[1,y], g.slp = growth[2,y], 
                 g.var = Var[y], AIC = aic[y], growth_notes = note[y])
      
      GrowthDataFrame <- rbind(GrowthDataFrame,df)
      
      # Survival model 
    if (length(subset3_S$size) >= minTrans){
      modS <- glm(survival ~ size, family = "binomial" , data = subset3_S)
      Snote[y] <- sprintf("Num of transitions = %s", 
                      length(subset3_S$size))
      
      survival[,y] <- coef(modS)
      aic_S[y] <- AIC(modS)
      }
    
    if (length(subset3_S$size) < minTrans){
      #setting values to NaNs
      Snote[y] <- sprintf("Not enough data. Num transitions = %s", 
                      length(subset3_S$size))
      survival[,y] <- NaN
      Var_S[y] <- NA
      aic_S[y] <- NA
      }
    
  
    # Row binding the model results into the survival model dataframe
    
    dfS <- data.frame(Model_IDs = sprintf("%s_%s_%s",Focus[i], 
                                           subFocus[v], subFocus2[y]), 
                                  s.int = survival[1,y], s.slp = survival[2,y], 
                                  AIC = aic_S, survival_notes = 
                                  sprintf("Num of transitions used equals %s", 
                                          length(subset3_S)))
    
    SurvivalDataFrame <- rbind(SurvivalDataFrame,dfS)
      
    }}}

```

Testing the model interactions. Maybe this makes more sense to have earlier on the page but this is here for reference as to why we coded the models this way. We were interested in extracting the values for the IPM parameters.

```{r Interactions,}
################################################################################
# Model interactions by genus: Growth ##########################################
#### SITE ######################################################################
################################################################################

mod_site_POCS <- lm(ln_ES ~ ln_SS + Site, 
           data = Growth[Growth$Genus_Code == GeneraNames[1],])
summary(mod_site_POCS)
drop1(mod_site_POCS, test="F")

mod_site_POSP <- lm(ln_ES ~ ln_SS + Site, 
           data = Growth[Growth$Genus_Code == GeneraNames[2],])
summary(mod_site_POSP)
drop1(mod_site_POSP, test="F")

mod_site_MOSC <- lm(ln_ES ~ ln_SS + Site, 
           data = Growth[Growth$Genus_Code == GeneraNames[3],])
summary(mod_site_MOSC)
drop1(mod_site_MOSC, test="F")

################################################################################
# Model interactions by genus: Survival ########################################
#### SITE ######################################################################
################################################################################

modS_site_POCS <- glm(survival ~ size + Site, family = "binomial" ,
           data = surv_dat[surv_dat$Genus_Code == GeneraNames[1],])
summary(modS_site_POCS)
drop1(modS_site_POCS, test="F")

modS_site_POSP <- glm(survival ~ size + Site, family = "binomial" , 
           data = surv_dat[surv_dat$Genus_Code == GeneraNames[2],])
summary(modS_site_POSP)
drop1(modS_site_POSP, test="F")

modS_site_MOSC <- glm(survival ~ size + Site, family = "binomial" , 
           data = surv_dat[surv_dat$Genus_Code == GeneraNames[3],])
summary(modS_site_MOSC)
drop1(modS_site_MOSC, test="F")
```


#Plot full growth model1
```{r Plotting full growth model 1, }
plot(ln_ES ~ ln_SS ,data = ColonyLevel)
abline(a=Glist_genera$g.int[1], b=Glist_genera$g.slp[1], col='red', lwd=2)
abline(a=Glist_genera$g.int[2], b=Glist_genera$g.slp[2], col='blue', lwd=2)
abline(a=Glist_genera$g.int[3], b=Glist_genera$g.slp[3], col='green', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("red","blue","green"),
       legend= GeneraNames , cex = 0.8)

#plot each genus separately
par(mfrow=c(1,3))
#Pocillopora
plot(ln_ES ~ ln_SS ,data = ColonyLevel,
     main="Pocillopora growth fit at all sites")
abline(a=Glist_genera$g.int[1], b=Glist_genera$g.slp[1], col='red', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("red"),
       legend= 'POCS' , cex = 0.8)
#Porites
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Porites growth fit at all sites")
abline(a=Glist_genera$g.int[2], b=Glist_genera$g.slp[2], col='blue', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("blue"),
       legend= 'POSP' , cex = 0.8)
#Montipora
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Montipora growth fit at all sites")
abline(a=Glist_genera$g.int[3], b=Glist_genera$g.slp[3], col='green', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("green"),
       legend= 'MOSP' , cex = 0.8)

```
#Plotting full growth model 2
```{r Plotting full growth model 2,}

#Plot full growth model2
LoopLeng <- length(SiteNames)
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Each site growth fit for all genera + all interval years")
for (i in 1:LoopLeng) {
  abline(a=Glist_site$g.int[i], b=Glist_site$g.slp[i], col=i , lwd=2)
}
legend("topleft", bty = "n", lty = c(1,1), col = 1:11,
       legend= SiteNames , cex = 0.8, pt.cex = .7)


#plot each site's growth model separately
LoopLeng <- length(SiteNames)
par(mfrow=c(4,3))
for (h in 1:LoopLeng) {
  plot(ln_ES ~ ln_SS ,data = ColonyLevel)
    abline(a=Glist_site$g.int[h], b=Glist_site$g.slp[h], col=h , lwd=2)
  legend("topleft", bty = "n", lty = c(1,1), col = h,
         legend= SiteNames[h], cex = 0.6, pt.cex = .5)
}

```

#Plot full growth model 3
Each Interval Year for all sites & genera
```{r Plotting full growth model 2,}
#Plot full growth model3
#mad right now bc of NA values
LoopL <- length(IntervalYears)
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Each interval growth fit for all genera + all sites")
for (m in 1:LoopL) {
  abline(a=Glist_years$g.int[m], b=Glist_years$g.slp[m], col=m , lwd=2)
}
legend("topleft", bty = "n", lty = c(1,1), col = 1:11,
       legend= IntervalYears, cex = 0.8, pt.cex = .7)


#which(is.na(Glist_years$g.slp)) #in which index is the glope NA?
#why does interval year 4.26557 have a negative slope?
#ColonyLevel$Site[ColonyLevel$Interval_Years == IntervalYears[10]] #ID the site that is in the 10th position in IntervalYears

#plot each site's growth model separately
par(mfrow=c(4,3))
for (c in 1:LoopL) {
  plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
       main="Each interval growth fit for all genera + all sites")
    abline(a=Glist_years$g.int[c], b=Glist_years$g.slp[c], col=c , lwd=2)
  legend("topleft", bty = "n", lty = c(1,1), col = c,
         legend= IntervalYears[c], cex = 0.6, pt.cex = .5)
}

```



#Survival
Delete once it's added to models 1-7:
```{r SurvivalMods, eval=TRUE}
# initializing the data runs for the survival analysis
ColonyLevel$ln_SS <- as.numeric(ColonyLevel$ln_SS)
ColonyLevel$ln_SS[ColonyLevel$ln_SS == -Inf] <-NA

# define the parms for model loop
Focus <- IntervalYears #change this each run
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Interval_Years #change this each run

# defining the matrix which holds the slope/int for each model run in the loop
growth <- matrix(0, nrow = 2, ncol = LoopLength)
survival <- matrix(0, nrow = 2, ncol = LoopLength)

for (i in 1:LoopLength){
  # subsetting to specifiy which interactions (genera/site/year) we care about
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  # for survival, all dead corals get a 0
  surv <- 1 - subset1$Mortality
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  # running the linear regression model for all growth
  modG <- lm(ln_ES ~ ln_SS ,data = subset2)
  # running the generalized linear model for survival
  modS <- glm(surv ~ ln_SS, family = "binomial", data = subset1)
  
  # saving the model
  growth[,i] <- coef(modG)
  survival[,i] <- coef(modS)
  
}

# moving model coefs into a list
# need to define the column names
Glist <- list(g.int = growth[1,], g.slp = growth[2,])
Slist <- list(s.int = survival[1,], s.slp = survival[2,])


# for each model grouping: 
# Comment out before new run
# Glist_genera <- Glist # Full model 1
# Glist_site <- Glist # Full model 2
 Glist_years <- Glist # Full model 3

 #survival 
# Comment out before new run
# Slist_genera <- Slist # Full model 1
# Slist_site <- Slist # Full model 2
 Slist_years <- Slist # Full model 3


```


#Reproduction
Work in progress. Delete once added to models 1-7
```{r SurvivalMods, eval=TRUE}

# define the parms for model loop
Focus <- GeneraNames #change this each run
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Genus_Code #change this each run

# defining the matrix which holds the slope/int for each model run in the loop
#WHY IS THIS NOT WORKING?!?!?
recruitment < - matrix(0, nrow = 2, ncol = LoopLength)

for (i in 1:LoopLength){
  # subsetting to specifiy which interactions (genera/site/year) we care about
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "RECR")
  
  #calculate unique time intervals
  timeint_unique <- unique(subset2$Interval_Years)
  
  #for every interval year, get the sum of the previous's years coral area (StartingSize)
  area <- rep(0,length(timeint_unique)) #initalize vector
  for (w in 1:length(timeint_unique)) {
    area[w] <- sum(subset2$StartingSize[which(subset2$Interval_Years== timeint_unique[w])]) 
    } #sum of patch areas for every time interval
  #number of recruits per transition (number recruits/interval year)
  numbrecruits <- rep(0,length(timeint_unique)) #initalize vector
  for (v in 1:length(timeint_unique)) { #for every interval year, get the sum of recruits for that interval year
    numbrecruits[v] <- sum(subset2$Recruit[which(subset2$Interval_Years== timeint_unique[v])])
    }
  numbrecruits <- round(numbrecruits/timeint_unique) #normalizes by time interval (# of recruits/time interval)
  
  # calculate the size specific recruitment rate for all recruitment & save
  #sizespecrec <- numbrecruits/area
  recruitment[,i] <- numbrecruits/area
  
}
#STILL NEED TO FIGURE OUT HOW TO SAVE CALCS

# moving model coefs into a list
# need to define the column names
Glist <- list(g.int = growth[1,], g.slp = growth[2,])
Rlist <- #list(s.int = survival[1,], s.slp = survival[2,])


# for each model grouping: 
# Comment out before new run
 Rlist_genera <- Rlist # Full model 1
# Rlist_site <- Rlist # Full model 2

```


#TO DO
[X] Run growth individual models 4-6
[X] Plot each genus separately (full growth model)
[X] Plot full growth model 2&3
[X] Figure out how to save into dataframe
[ ] Clean up script
[ ] Make powerpoint with some of our script and the plots
#Caroline
[ ] Fix growth plots (changed from list to df)
[ ] Plot survival models
[ ] Operationalize reprodution script
[ ] Plot reproduction models
[ ] Plot each individual growth model
[ ] Start IPM chunk set up
#Devynn
[ ] Add in survival to models 1-7
[X] Add AIC calcs into the dataframe
[X] Add variance into the dataframe
[ ] Maybe add reproduction into models 1-7?




#Main Questions for Friday meeting
1. Is this a good way to do the models? Should we be including interaction terms?
2. Why does IntervalYears not work as an interaction term?
- Because it is being considered as a continuous variable 
3. Does the way that we're modeling reproduction (# of recruits/area of parent coral) make sense? 
4. (ln_ES - ln_SS)*(1/Interval_Year) <- GY. == ln_ES_corrected = ln_SS + GY







