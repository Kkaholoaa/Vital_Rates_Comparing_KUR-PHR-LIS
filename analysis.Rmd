---
title: "analysis"
author: "Devynn M Wulstein"
date: "3/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = FALSE)
```

```{r}
## Loading libraries
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
```


```{r}
# Loading dataframe(s)
AllDataFrame <- load("data/Patch_And_Colony_Data_20201103.rdata")
```

```{r}
# Defining site IDs, genera names, and transition intervals (years) as lists
SiteNames <- as.character(unique(ColonyLevel$Site))
GeneraNames <- as.character(unique(ColonyLevel$Genus_Code))
IntervalYears <- unique(ColonyLevel$Interval_Years)

# Ensuring that the log size values are numbers (I think they are numeric, but maybe not!)
# And that the -Infs are NAs instead
ColonyLevel$ln_ES <- as.numeric(ColonyLevel$ln_ES)
ColonyLevel$ln_SS[ColonyLevel$ln_ES == -Inf] <-NA

ColonyLevel$ln_SS <- as.numeric(ColonyLevel$ln_SS)
ColonyLevel$ln_SS[ColonyLevel$ln_SS == -Inf] <-NA
```

We are next creating all of the unique IDs for the models run. These correspond to the models that look at all genera together and those that look at each genera separately at separate sites and separate interval years. 

```{r Creating the unique IDS,}
# Unique IDs for all models
#Prepping names
RIntY <- as.character(sapply(IntervalYears, round, 3))
TNam <- length(GeneraNames)
SNam <- length(SiteNames)
YNam <- length(RIntY)

nums <- TNam + SNam + YNam + YNam*TNam +
        SNam*TNam + YNam*TNam*SNam +1

UniqueIDs <- rep(0, length=nums)
UniqueIDs[1] <- "All_Genera_Site_Years"
a <- 2
b <- a + TNam -1
rng <- a:b
UniqueIDs[rng] <- sprintf("%s_All_Sites_Years",GeneraNames)

a <- b + 1
b <- a + SNam -1
rng <- a:b
UniqueIDs[rng] <- sprintf("%s_All_Taxa_Years", SiteNames)

a <- b + 1
b <- a + YNam -1
rng <- a:b
UniqueIDs[rng] <-sprintf("%s_All_Taxa_Sites", RIntY)

for (g in 1:TNam){
  a <- b+1
  b <- a + SNam -1
  rng <- a:b
  UniqueIDs[rng] <-sprintf("%s_%s_All_Years", 
                           rep(GeneraNames[g],length = SNam), 
                           SiteNames)}


# defining the name for the individual models! all 3x11x21 possible combos
for (i in 1:YNam){
  for (g in 1:TNam){
    a <- b + 1
    b <- a + SNam -1
    rng <- a:b
    UniqueIDs[rng] <- sprintf("%s_%s_%s", 
                              rep(GeneraNames[g],length = SNam), 
                              SiteNames,
                              rep(RIntY[i],length = SNam))
  }
}


```
The aim of this analysis is to calculate the kernel fits (growth, survival, & reproduction) for each combination of genera-site-year and then each separately. 

Full models:
(1) Each Genera for all sites & interval years
(2) Each Site for all genera & interval years
(3) Each Interval Year for all sites & genera

Individual models: (the more realistic models that we are more interested in)
(1) Each Genera by interval year, sites are not separated
(2) Each Genera by site, interval years are not separated
(3) Each genera by site and interval year (we will have parameter values that equal site * interval years * genera)

```{r FULLmodGROWTH, eval = TRUE}
################################################################################
################### Model with no separation of terms ##########################
################################################################################
growth <- subset(ColonyLevel, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")

mod <- lm(ln_ES ~ ln_SS, data = growth)

# saving model coefficients and notes into dataframe with corresponding uniqueID
GrowthDataFrame <- data.frame(Model_IDs = UniqueIDs[1], g.int = coef(mod)[1], 
                              g.slp = coef(mod)[2], growth_notes = 
                                sprintf("Num of transitions used equals %s", 
                                        length(growth$ln_SS)))

################################################################################
################### Models Separated by Major Groupings ########################
################# (1) Genera, (2) Site, and (3) Interval Year ##################
################################################################################

################################################################################
###### 1. Genera models ########################################################
################################################################################
  
# initializing the data runs for the growth analysis
# define the parms for model loop
Focus <- GeneraNames 
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Genus_Code
minTrans <- 4 # minimum number of transitions

growth <- matrix(0, nrow = 2, ncol = LoopLength)
note <- c()
for (i in 1:LoopLength){
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS
  ln_ES <- subset2$ln_ES
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    note[i] <- sprintf("Num of transitions = %s", 
                    length(ln_SS))
    
    growth[,i] <- coef(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    note[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(ln_SS))
    growth[,i] <- NaN}}

# save lists as dataframe and then column bind them into the growth dataframe
a <- length(GrowthDataFrame$Model_IDs) + 1
b <- a + length(Focus) - 1

df <- data.frame(Model_IDs = UniqueIDs[a:b], 
                 g.int = growth[1,], g.slp = growth[2,], 
                 growth_notes = note)

GrowthDataFrame <- rbind(GrowthDataFrame,df)

################################################################################
###### 2. Site models ##########################################################
################################################################################

# initializing the data runs for the growth analysis
# define the parms for model loop
Focus <- SiteNames 
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Site
minTrans <- 4 # minimum number of transitions

growth <- matrix(0, nrow = 2, ncol = LoopLength)
note <- c()
for (i in 1:LoopLength){
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS
  ln_ES <- subset2$ln_ES
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    note[i] <- sprintf("Num of transitions = %s", 
                    length(ln_SS))
    
    growth[,i] <- coef(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    note[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(ln_SS))
    growth[,i] <- NaN}}

# save lists as dataframe and then column bind them into the growth dataframe
a <- length(GrowthDataFrame$Model_IDs) + 1
b <- a + length(Focus) - 1
df <- data.frame(Model_IDs = UniqueIDs[a:b], 
                 g.int = growth[1,], g.slp = growth[2,], 
                 growth_notes = note)

GrowthDataFrame <- rbind(GrowthDataFrame,df)

################################################################################
###### 3. Interval Year models #################################################
################################################################################

# initializing the data runs for the growth analysis
# define the parms for model loop
Focus <- IntervalYears 
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Interval_Years
minTrans <- 4 # minimum number of transitions

growth <- matrix(0, nrow = 2, ncol = LoopLength)
note <- c()
for (i in 1:LoopLength){
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS
  ln_ES <- subset2$ln_ES
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    note[i] <- sprintf("Num of transitions = %s", 
                    length(ln_SS))
    
    growth[,i] <- coef(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    note[i] <- sprintf("Not enough data. Num transitions = %s", 
                    length(ln_SS))
    growth[,i] <- NaN}}

# save lists as dataframe and then column bind them into the growth dataframe
a <- length(GrowthDataFrame$Model_IDs) + 1
b <- a + length(Focus) - 1
df <- data.frame(Model_IDs = UniqueIDs[a:b], 
                 g.int = growth[1,], g.slp = growth[2,], 
                 growth_notes = note)

GrowthDataFrame <- rbind(GrowthDataFrame,df)

```
#Plot full growth model1
```{r Plotting full growth model 1, }
plot(ln_ES ~ ln_SS ,data = ColonyLevel)
abline(a=Glist_genera$g.int[1], b=Glist_genera$g.slp[1], col='red', lwd=2)
abline(a=Glist_genera$g.int[2], b=Glist_genera$g.slp[2], col='blue', lwd=2)
abline(a=Glist_genera$g.int[3], b=Glist_genera$g.slp[3], col='green', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("red","blue","green"),
       legend= GeneraNames , cex = 0.8)

#plot each genus separately
par(mfrow=c(1,3))
#Pocillopora
plot(ln_ES ~ ln_SS ,data = ColonyLevel,
     main="Pocillopora growth fit at all sites")
abline(a=Glist_genera$g.int[1], b=Glist_genera$g.slp[1], col='red', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("red"),
       legend= 'POCS' , cex = 0.8)
#Porites
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Porites growth fit at all sites")
abline(a=Glist_genera$g.int[2], b=Glist_genera$g.slp[2], col='blue', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("blue"),
       legend= 'POSP' , cex = 0.8)
#Montipora
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Montipora growth fit at all sites")
abline(a=Glist_genera$g.int[3], b=Glist_genera$g.slp[3], col='green', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("green"),
       legend= 'MOSP' , cex = 0.8)

```
#Plotting full growth model 2
```{r Plotting full growth model 2,}

#Plot full growth model2
LoopLeng <- length(SiteNames)
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Each site growth fit for all genera + all interval years")
for (i in 1:LoopLeng) {
  abline(a=Glist_site$g.int[i], b=Glist_site$g.slp[i], col=i , lwd=2)
}
legend("topleft", bty = "n", lty = c(1,1), col = 1:11,
       legend= SiteNames , cex = 0.8, pt.cex = .7)


#plot each site's growth model separately
LoopLeng <- length(SiteNames)
par(mfrow=c(4,3))
for (h in 1:LoopLeng) {
  plot(ln_ES ~ ln_SS ,data = ColonyLevel)
    abline(a=Glist_site$g.int[h], b=Glist_site$g.slp[h], col=h , lwd=2)
  legend("topleft", bty = "n", lty = c(1,1), col = h,
         legend= SiteNames[h], cex = 0.6, pt.cex = .5)
}

```

#Plot full growth model 3
Each Interval Year for all sites & genera
```{r Plotting full growth model 2,}
#Plot full growth model3
#mad right now bc of NA values
LoopL <- length(IntervalYears)
plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
     main="Each interval growth fit for all genera + all sites")
for (m in 1:LoopL) {
  abline(a=Glist_years$g.int[m], b=Glist_years$g.slp[m], col=m , lwd=2)
}
legend("topleft", bty = "n", lty = c(1,1), col = 1:11,
       legend= IntervalYears, cex = 0.8, pt.cex = .7)


#which(is.na(Glist_years$g.slp)) #in which index is the glope NA?
#why does interval year 4.26557 have a negative slope?
#ColonyLevel$Site[ColonyLevel$Interval_Years == IntervalYears[10]] #ID the site that is in the 10th position in IntervalYears

#plot each site's growth model separately
par(mfrow=c(4,3))
for (c in 1:LoopL) {
  plot(ln_ES ~ ln_SS ,data = ColonyLevel, 
       main="Each interval growth fit for all genera + all sites")
    abline(a=Glist_years$g.int[c], b=Glist_years$g.slp[c], col=c , lwd=2)
  legend("topleft", bty = "n", lty = c(1,1), col = c,
         legend= IntervalYears[c], cex = 0.6, pt.cex = .5)
}

```



Each Genera by interval year, sites are not separated
Growth (line 116) is messed up
```{r IndividualGrowthMods, eval=TRUE}
# initializing the data runs for the growth analysis

# define the parms for model loop
minTrans <- 1
Focus <- GeneraNames
subFocus <- IntervalYears
LoopLength <- length(Focus)
LoopLengthSF <-  length(subFocus)
Spec_selection <- ColonyLevel$Genus_Code
Spec_selectionSF <- ColonyLevel$Interval_Years

# defining the matrix/list which holds the slope/int for each model run in the loop
AllList_g2 <- list(Focus)

for (i in 1:LoopLength){
  growth <- matrix(0, nrow = 2, ncol = (LoopLengthSF))
  # subsetting to specifiy which interactions (genera/site/year) we care about
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  for (v in 1:LoopLengthSF){
    subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS[Monty2$Interval_Years == subFocus[v]]
  ln_ES <- subset2$ln_ES[Monty2$Interval_Years == subFocus[v]]
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    # saving the model
    growth[,v] <- coef(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    growth[,v] <- NaN}
  }
  gList <- list(g.int = growth[1,], g.slp = growth[2,])
  AllList_g2[Focus[i]] <- list(gList)
}

```


```{r}
NewLists <- list(Focus)

List <- list(1:LoopLengthSF)

for (i in 1:3){
 # i = 1
for (v in 1:LoopLengthSF){
  #v = 1
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
  ss <- unique(subset2$Site)
  glist1 <- list(SiteNames)
  growth <- matrix(0, nrow = 2, ncol = 1)
  for (s in 1:length(ss)){
    #s = 2
    ln_SS <- subset2$ln_SS[subset2$Interval_Years == subFocus[v] & 
                             subset2$Site == ss[s]]
    
    ln_ES <- subset2$ln_ES[subset2$Interval_Years == subFocus[v] & 
                             subset2$Site == ss[s]]
    #subset3 <- subset(subset3, Spec_selectionSF == subFocus[v])
    # subsetting for growth & shrinkage
    ThisSite <- SiteNames[SiteNames == ss[s]]
    
    if (length(ln_SS) > 1){
      mod <- lm(ln_ES ~ ln_SS)
      # saving the model
      growth <- coef(mod)}
  
    if (length(ln_SS) < 1){
      #setting values to NaNs
      growth[1] <- sprintf("Not enough data for site: %s", ThisSite)
      growth[2] <- sprintf("Not enough data for site: %s", ThisSite)
    }
    
      Sites <- list(g.int = growth[1], g.slp = growth[2])
      glist1[ThisSite] <- list(Sites)
  } 
    #gListS <- list(g.int = growth[1,], g.slp = growth[2,])
    List[v] <- list(glist1)
}
NewLists[Focus[i]] <- list(List)
}
# running the linear regression model$
```

#Survival
```{r SurvivalMods, eval=TRUE}
#NOTES
#all survival (all sites all genera)
surv <- 1 - ColonyLevel$Mortality #if it dies it's a 0
ColonyLevel$ln_SS <- as.numeric(ColonyLevel$ln_SS)
ColonyLevel$ln_SS[ColonyLevel$ln_SS == -Inf] <-NA
#fit
gn <- glm(surv ~ ln_SS, family = "binomial", data = ColonyLevel)
gn
#Pocillopora
surv_POCS <- 1 - Poc$Mortality
Poc$ln_SS <- as.numeric(Poc$ln_SS)
Poc$ln_SS[Poc$ln_SS == -Inf] <-NA
#fit
gn_POCS <- glm(surv_POCS ~ ln_SS, family = "binomial", data = Poc)
gn_POCS


#attempting loop
# initializing the data runs for the survival analysis
surv <- 1 - ColonyLevel$Mortality #if it dies it's a 0
ColonyLevel$ln_SS <- as.numeric(ColonyLevel$ln_SS)
ColonyLevel$ln_SS[ColonyLevel$ln_SS == -Inf] <-NA
# define the parms for model loop
SFocus <- GeneraNames #change this each run
SLoopLength <- length(SFocus)
Spec_selection <- ColonyLevel$Genus_Code #change this each run
# defining the matrix which holds the slope/int for each model run in the loop
survival <- matrix(0, nrow = 2, ncol = SLoopLength)
for (s in 1:SLoopLength){
  # subsetting to specifiy which interactions (genera/site/year) we care about
  subset1 <- subset(ColonyLevel, Spec_selection == SFocus[s])
  
  # subsetting for survival
  #subset2 <- subset(subset1, TransitionTypeSimple == "MORT")
  surv <- 1 - ColonyLevel$Mortality
  
  # running the generalized linear model
  modS <- glm(surv ~ ln_SS, family = "binomial", data = subset2)
  
  # saving the model
  survival[,s] <- coef(modS)
  
}
# moving model coefs into a list
Slist <- list(s.int = survival[1,], s.slp = survival[2,])

# for each model grouping: 
# Comment out before new run
 Slist_genera <- Slist # Full model 1
# Slist_site <- Slist # Full model 2
# Slist_years <- Slist # Full model 3
```




#TO DO
[ ] Fix growth line
[ ] Then run growth individual models 2 & 3
[X] Plot each genus separately (full growth model)
[X] Plot each full growth model
[X] Plot each full growth model w/ specific data
[ ] Plot each individual growth model
[ ] Figure out how to save into dataframe
[ ] Clean up script
[ ] Operationalize survival script
[ ] Plot survival models
[ ] Operationalize reproducion script
[ ] Plot reproduction models



