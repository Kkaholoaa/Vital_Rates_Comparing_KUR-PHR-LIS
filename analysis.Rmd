---
title: "analysis"
author: "Devynn M Wulstein"
date: "3/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(cache = FALSE)
```

```{r}
## Loading libraries
library(ggplot2)
library(plyr)
library(dplyr)
library(tidyr)
```


```{r}
# Loading dataframe(s)
AllDataFrame <- load("data/Patch_And_Colony_Data_20201103.rdata")
```

```{r}
# Defining site IDs, genera names, and transition intervals (years) as lists
SiteNames <- as.character(unique(ColonyLevel$Site))
GeneraNames <- as.character(unique(ColonyLevel$Genus_Code))
IntervalYears <- unique(ColonyLevel$Interval_Years)
```

The aim of this analysis is to calculate the kernel fits (growth, survival, & reproduction) for each combination of genera-site-year and then each separately. 

Full models:
(1) Each Genera for all sites & interval years
(2) Each Site for all genera & interval years
(3) Each Interval Year for all sites & genera

Individual models: (the more realistic models that we are more interested in)
(1) Each Genera by interval year, sites are not separated
(2) Each Genera by site, interval years are not separated
(3) Each genera by site and interval year (we will have parameter values that equal site * interval years * genera)

```{r FULLmodGROWTH, eval = TRUE}
# initializing the data runs for the growth analysis

# define the parms for model loop
Focus <- SiteNames #change this each run
LoopLength <- length(Focus)
Spec_selection <- ColonyLevel$Site #change this each run

# defining the matrix which holds the slope/int for each model run in the loop
growth <- matrix(0, nrow = 2, ncol = LoopLength)


for (i in 1:LoopLength){
  # subsetting to specifiy which interactions (genera/site/year) we care about
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  # subsetting for growth & shrinkage
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                   TransitionTypeSimple == "SHRINK")
  
  # running the linear regression model
  modG <- lm(ln_ES ~ ln_SS ,data = subset2)
  
  # saving the model
  growth[,i] <- coef(modG)
  
}

# moving model coefs into a list
# need to define the column names
Glist <- list(g.int = growth[1,], g.slp = growth[2,])

# for each model grouping: 
# Comment out before new run
# Glist_genera <- Glist # Full model 1
 Glist_site <- Glist # Full model 2
# Glist_years <- Glist # Full model 3

#doesn't work yet...trying to name cols in list
#dimnames(Glist_genera) <- list("POCS", "POSP", "MOSP" )

```
#Plot full growth model1
```{r Plotting full growth model 1, }
plot(ln_ES ~ ln_SS ,data = ColonyLevel)
abline(a=Glist_genera$g.int[1], b=Glist_genera$g.slp[1], col='red', lwd=2)
abline(a=Glist_genera$g.int[2], b=Glist_genera$g.slp[2], col='blue', lwd=2)
abline(a=Glist_genera$g.int[3], b=Glist_genera$g.slp[3], col='green', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("red","blue","green"),
       legend= GeneraNames , cex = 0.8)

#plot each genus separately
par(mfrow=c(1,3))
#Pocillopora
plot(ln_ES ~ ln_SS ,data = ColonyLevel, main="Pocillopora growth fit at all sites")
abline(a=Glist_genera$g.int[1], b=Glist_genera$g.slp[1], col='red', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("red"),
       legend= 'POCS' , cex = 0.8)
#Porites
plot(ln_ES ~ ln_SS ,data = ColonyLevel, main="Porites growth fit at all sites")
abline(a=Glist_genera$g.int[2], b=Glist_genera$g.slp[2], col='blue', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("blue"),
       legend= 'POSP' , cex = 0.8)
#Montipora
plot(ln_ES ~ ln_SS ,data = ColonyLevel, main="Montipora growth fit at all sites")
abline(a=Glist_genera$g.int[3], b=Glist_genera$g.slp[3], col='green', lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = c("green"),
       legend= 'MOSP' , cex = 0.8)

```
#Plotting full growth model 2
```{r Plotting full growth model 2,}

#Plot full growth model2
LoopLeng <- length(SiteNames)
plot(ln_ES ~ ln_SS ,data = ColonyLevel, main="Each site growth fit for all genera + all interval years")
for (i in 1:LoopLeng) {
  abline(a=Glist_site$g.int[i], b=Glist_site$g.slp[i], col=i , lwd=2)
}
legend("topleft", bty = "n", lty = c(1,1), col = 1:11,
       legend= SiteNames , cex = 0.8, pt.cex = .7)


#plot each site's growth model separately
LoopLeng <- length(SiteNames)
par(mfrow=c(4,3))
for (h in 1:LoopLeng) {
  plot(ln_ES ~ ln_SS ,data = ColonyLevel)
    abline(a=Glist_site$g.int[h], b=Glist_site$g.slp[h], col=h , lwd=2)
  legend("topleft", bty = "n", lty = c(1,1), col = h,
         legend= SiteNames[h], cex = 0.6, pt.cex = .5)
}

```
#Plot full growth model 3
Each Interval Year for all sites & genera
```{r Plotting full growth model 2,}
#silly way
plot(ln_ES ~ ln_SS ,data = ColonyLevel, main="Each interval growth fit for all genera + all sites")
abline(a=Glist_years$g.int[1], b=Glist_years$g.slp[1], col=1:12, lwd=2)
abline(a=Glist_years$g.int[2], b=Glist_years$g.slp[2], col=2:12, lwd=2)
abline(a=Glist_years$g.int[3], b=Glist_years$g.slp[3], col=3:12, lwd=2)
abline(a=Glist_years$g.int[4], b=Glist_years$g.slp[4], col=4:12, lwd=2)
abline(a=Glist_years$g.int[5], b=Glist_years$g.slp[5], col=5:12, lwd=2)
abline(a=Glist_years$g.int[6], b=Glist_years$g.slp[6], col=6:12, lwd=2)
abline(a=Glist_years$g.int[7], b=Glist_years$g.slp[7], col=7:12, lwd=2)
abline(a=Glist_years$g.int[8], b=Glist_years$g.slp[8], col=8:12, lwd=2)
abline(a=Glist_years$g.int[9], b=Glist_years$g.slp[9], col=9:12, lwd=2)
abline(a=Glist_years$g.int[10], b=Glist_years$g.slp[10], col=10:12, lwd=2)
abline(a=Glist_years$g.int[11], b=Glist_years$g.slp[11], col=11:12, lwd=2)
legend("topleft", bty = "n", lty = c(1,1), col = 1:11,
       legend= IntervalYears , cex = 0.8, pt.cex = .7)

#why does interval year 4.26557 have a negative slope?
ColonyLevel$Site[ColonyLevel$Interval_Years == IntervalYears[10]] #ID the site that is in the 10th position in IntervalYears

#attempt
LoopLength <- length(IntervalYears)
plot(ln_ES ~ ln_SS ,data = ColonyLevel, main="Each interval growth fit for all genera + all sites")
for (i in 1:LoopLength) {
  abline(a=Glist_years$g.int[i], b=Glist_years$g.slp[i], col=i, lwd=2)
}
legend("topleft", bty = "n", lty = c(1,1), col = 1:21,
       legend= IntervalYears , cex = 0.8, pt.cex = .7)



```




Each Genera by interval year, sites are not separated
Growth (line 116) is messed up
```{r IndividualGrowthMods, eval=TRUE}
# initializing the data runs for the growth analysis

# define the parms for model loop
minTrans <- 1
Focus <- GeneraNames
subFocus <- IntervalYears
LoopLength <- length(Focus)
LoopLengthSF <-  length(subFocus)
Spec_selection <- ColonyLevel$Genus_Code
Spec_selectionSF <- ColonyLevel$Interval_Years

# defining the matrix which holds the slope/int for each model run in the loop
AllList_g2 <- list(Focus)

for (i in 1:LoopLength){
  growth <- matrix(0, nrow = 2, ncol = (LoopLengthSF))
  # subsetting to specifiy which interactions (genera/site/year) we care about
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  
  for (v in 1:LoopLengthSF){
    subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
  
  ln_SS <- subset2$ln_SS[Monty2$Interval_Years == subFocus[v]]
  ln_ES <- subset2$ln_ES[Monty2$Interval_Years == subFocus[v]]
  
  if (length(ln_SS) > minTrans){
    mod <- lm(ln_ES ~ ln_SS)
    # saving the model
    growth[,v] <- coef(mod)}
  
  if (length(ln_SS) <= minTrans){
    #setting values to NaNs
    growth[,v] <- NaN}
  }
  gList <- list(g.int = growth[1,], g.slp = growth[2,])
  AllList_g2[Focus[i]] <- list(gList)
}

```


```{r}
NewLists <- list(Focus)

List <- list(1:LoopLengthSF)

for (i in 1:3){
 # i = 1
for (v in 1:LoopLengthSF){
  #v = 1
  subset1 <- subset(ColonyLevel, Spec_selection == Focus[i])
  subset2 <- subset(subset1, TransitionTypeSimple == "GROWTH" | 
                 TransitionTypeSimple == "SHRINK")
  ss <- unique(subset2$Site)
  glist1 <- list(SiteNames)
  growth <- matrix(0, nrow = 2, ncol = 1)
  for (s in 1:length(ss)){
    #s = 2
    ln_SS <- subset2$ln_SS[subset2$Interval_Years == subFocus[v] & 
                             subset2$Site == ss[s]]
    
    ln_ES <- subset2$ln_ES[subset2$Interval_Years == subFocus[v] & 
                             subset2$Site == ss[s]]
    #subset3 <- subset(subset3, Spec_selectionSF == subFocus[v])
    # subsetting for growth & shrinkage
    ThisSite <- SiteNames[SiteNames == ss[s]]
    
    if (length(ln_SS) > 1){
      mod <- lm(ln_ES ~ ln_SS)
      # saving the model
      growth <- coef(mod)}
  
    if (length(ln_SS) < 1){
      #setting values to NaNs
      growth[1] <- sprintf("Not enough data for site: %s", ThisSite)
      growth[2] <- sprintf("Not enough data for site: %s", ThisSite)
    }
    
      Sites <- list(g.int = growth[1], g.slp = growth[2])
      glist1[ThisSite] <- list(Sites)
  } 
    #gListS <- list(g.int = growth[1,], g.slp = growth[2,])
    List[v] <- list(glist1)
}
NewLists[Focus[i]] <- list(List)
}
# running the linear regression model$
```
#TO DO
[ ] Fix growth line
[ ] Then run individual models 2 & 3
[X] Plot each genus separately (full model)
[ ] Plot each full model
[ ] Plot each individual model
[ ] Figure out how to save into dataframe
[ ] Repeat for survival
[ ] Repeat for reproduction



